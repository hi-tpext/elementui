<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1,
        maximum-scale=1, user-scalable=no" />
  <title>首页 - {$admin_page_title|default=''}</title>
  <link rel="icon" href="{$admin_favicon|default=''}" type="image/ico">
  <meta name="description" content="{$admin_page_description|default=''}">
  <link rel="stylesheet" href="/assets/elementui/lib/theme-chalk/index.css?v={$admin_assets_ver|default='1.0'}" />
  <link rel="stylesheet" href="/assets/elementui/css/index.css?v={$admin_assets_ver|default='1.0'}" />
  <link rel="stylesheet"
    href="/assets/lightyearadmin/css/materialdesignicons.min.css?v={$admin_assets_ver|default='1.0'}">
</head>

<body>
  <div id="app" class="hidden" element-loading-background="rgba(0, 0, 0, 0.3)">
    <div class="page-layout" :class="{ collapse: menuCollapse }">
      <!-- 遮罩层 -->
      <div class="page-layout__mask" @click="collapseMenu(true)"></div>

      <div class="page-layout__left">
        <!-- 侧栏 -->
        <div class="app-slider">
          <div class="app-slider__logo">
            <template v-if="menuCollapse || browser.isMini">
              <span @click="collapseMenu(false)"><img class="mini"
                  src="/assets/elementui/icon/logo/silder-simple.png" /></span>
            </template>
            <template v-else>
              {$admin_logo|raw|default='admin'}
            </template>
          </div>
          <div class="app-slider__menu">
            <div class="cl-slider-menu" v-show="leftMenuVisible">
              <el-menu default-active='' background-color="transparent" :collapse-transition="false"
                :collapse="browser.isMini ? false : menuCollapse" @select="leftMenuSelect">
                <template v-for="(item, index) in leftMenu">
                  <el-submenu v-if="item.children && item.children.length" popper-class="cl-slider-menu__submenu"
                    :index="item.id">
                    <template slot="title">
                      <i class="munu-icon" :class="item.icon"></i>
                      <span slot="title">{{item.name}}</span>
                    </template>
                    <template v-for="(subitem1, index) in item.children">
                      <el-submenu v-if="subitem1.children && subitem1.children.length"
                        popper-class="cl-slider-menu__submenu" :index="subitem1.id">
                        <template slot="title">
                          <i class="munu-icon" :class="subitem1.icon"></i>
                          <span slot="title">{{subitem1.name}}</span>
                        </template>
                        <template v-for="(subitem2, index) in subitem1.children">
                          <el-submenu v-if="subitem2.children && subitem2.children.length"
                            popper-class="cl-slider-menu__submenu" :index="subitem2.id">
                            <template slot="title">
                              <i class="munu-icon" :class="subitem2.icon"></i>
                              <span slot="title">{{subitem2.name}}</span>
                            </template>
                          </el-submenu>
                          <el-menu-item v-else :index="subitem2.id">
                            <i class="munu-icon" :class="subitem2.icon"></i>
                            <span slot="title">{{subitem2.name}}</span>
                          </el-menu-item>
                        </template>
                      </el-submenu>
                      <el-menu-item v-else :index="subitem1.id">
                        <i class="munu-icon" :class="subitem1.icon"></i>
                        <span slot="title">{{subitem1.name}}</span>
                      </el-menu-item>
                    </template>
                  </el-submenu>
                  <el-menu-item v-else :index="item.id" :key="item.id">
                    <i class="munu-icon" :class="item.icon"></i>
                    <span slot="title">{{item.name}}</span>
                  </el-menu-item>
                </template>
              </el-menu>
            </div>
          </div>
        </div>
      </div>

      <div class="page-layout__right">
        <!-- 顶栏 -->
        <div class="page-layout__topbar">
          <div class="app-topbar">
            <div class="app-topbar__collapse" @click="collapseMenu(!menuCollapse)">
              <i :class="[menuCollapse ? 'el-icon-s-unfold' : 'el-icon-s-fold']"></i>
            </div>

            <!-- 一级菜单 -->
            <div class="app-topbar__menu">
              <div class="cl-menu-topbar">
                <!-- <el-menu :default-active="index" mode="horizontal" background-color="transparent" @select="onSelect">
                  <el-menu-item v-for="(item, index) in toplist" :index="`${index}`" :key="index">
                    <icon-svg v-if="item.icon" :name="item.icon" :size="18"></icon-svg>
                    <span>{{ item.name }}</span>
                  </el-menu-item>
                </el-menu> -->
              </div>
            </div>

            <div class="cl-route-nav">
              <p class="title" v-if="!browser.isMini">
                {$admin_page_title|default='admin'}
              </p>
            </div>

            <div class="flex1"></div>
            <!-- 工具栏 -->
            <ul class="app-topbar__tools">
              <li>
                <a title="打开首页" href="/" target="_blank"><i class="el-icon-house"></i></a>
              </li>
              {if condition="checkUrl(url('/admin/index/clearcache'))"}
              <li>
                <a title="清空缓存" @click="onCommand('清空缓存|{:url('/admin/index/clearcache')}')"><i
                    class="el-icon-delete"></i></a>
              </li>
              {/if}
              <!-- 主题 -->
              <li @click="openTheme">
                <a title="主题"><i class="el-icon-magic-stick"></i></a>
              </li>
              {:\\tpext\\common\\ExtLoader::trigger('topbar_right_links')}
            </ul>
            <div class="cl-theme">
              <!-- 系统设置 -->
              <el-drawer title="系统设置" :visible.sync="drawer.visible" size="300px">
                <div class="cl-theme__container">
                  <div class="cl-theme__color is-card">
                    <p>主题</p>
                    <ul>
                      <el-tooltip v-for="(item, name) in themes" :key="name" :content="item.label" placement="top">
                        <li :style="{
                                backgroundColor: item.color
                              }" @click="setTheme(item)">
                          <i class="el-icon-check" v-show="item.color == theme.color"></i>
                        </li>
                      </el-tooltip>
                    </ul>
                  </div>
                  <div class="cl-theme__switch is-card">
                    <p>内容区域</p>
                    <ul>
                      <li v-if="!browser.isMini">
                        <span>显示一级菜单栏</span>
                        <el-switch size="mini" v-model="conf.showAMenu"></el-switch>
                      </li>
                      <li>
                        <span>显示路由导航栏</span>
                        <el-switch size="mini" v-model="conf.showRouteNav"></el-switch>
                      </li>
                      <li>
                        <span>显示页面进程栏</span>
                        <el-switch size="mini" v-model="conf.showProcess"></el-switch>
                      </li>
                    </ul>
                  </div>
                </div>
              </el-drawer>
            </div>
            <!-- 用户信息 -->
            <div class="app-topbar__user">
              <el-dropdown trigger="click" @command="onCommand">
                <span class="el-dropdown-link">
                  <span class="name"
                    title="{$admin_user.group_name|default=''}">{$admin_user.name|default='Tpext'}</span>
                  <img class="avatar" src="{$admin_user.avatar|default='/assets/lightyearadmin/images/no-avatar.jpg'}"
                    alt />
                </span>
                <el-dropdown-menu slot="dropdown" class="popper-dropdown-menu-user">
                  <el-dropdown-item command="个人中心|{:url('/admin/index/profile')}">个人中心</el-dropdown-item>
                  <el-dropdown-item command="修改密码|{:url('/admin/index/changepwd')}">修改密码</el-dropdown-item>
                  <el-dropdown-item command="exit">退出</el-dropdown-item>
                </el-dropdown-menu>
              </el-dropdown>
            </div>
          </div>
        </div>

        <!-- 页面进程 -->
        <div v-if="conf.showProcess" class="page-layout__process">
          <div class="app-process">
            <div class="app-process__left hidden-xs-only" @click="toScroll(true)">
              <i class="el-icon-arrow-left"></i>
            </div>
            <div class="app-process__scroller" ref="scroller">
              <div class="app-process__item" v-for="(item, index) in processList" :key="index" :ref="`item-${item.id}`"
                :class="{ active: activeTabId == item.id}" :data-index="index" @click="activeItem(item,index)">
                <span>{{ item.label }}</span>
                <i class="el-icon-close" v-if="index > 0" @click.stop="onDel(index)"></i>
              </div>
            </div>
            <el-dropdown @command="tabDropdownAction">
              <span class="el-dropdown-link">
                操作<i class="el-icon-arrow-down el-icon--right"></i>
              </span>
              <el-dropdown-menu slot="dropdown">
                <el-dropdown-item command="current" icon="el-icon-minus">关闭当前</el-dropdown-item>
                <el-dropdown-item command="other" icon="el-icon-remove-outline">关闭其他</el-dropdown-item>
                <el-dropdown-item command="all" icon="el-icon-circle-close">关闭所有</el-dropdown-item>
              </el-dropdown-menu>
            </el-dropdown>
            <div class="app-process__right hidden-xs-only" @click="toScroll(false)">
              <i class="el-icon-arrow-right"></i>
            </div>
          </div>
        </div>

        <!-- 页面视图 -->
        <div class="page-layout__container" v-loading="iframeLoading">
          <div class="page-layout__view">
            <iframe @load="iframeLoading=false" :style="{ display: activeTabId == item.id ? 'block' : 'none'}"
              v-for="(item, index) in processList" :key="index" :name="'iframe'+index" width="100%" height="100%"
              :src="item.value" frameborder="0" :data-url="item.value" seamless></iframe>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script type="text/javascript" src="/assets/elementui/lib/vue.min.js?v={$admin_assets_ver|default='1.0'}"
    charset="utf-8"></script>
  <script type="text/javascript" src="/assets/elementui/lib/index.js?v={$admin_assets_ver|default='1.0'}"
    charset="utf-8"></script>
  <script type="text/javascript" src="/assets/elementui/lib/axios.min.js?v={$admin_assets_ver|default='1.0'}"
    charset="utf-8"></script>
  <script type="text/javascript" src="/assets/elementui/js/index.js?v={$admin_assets_ver|default='1.0'}"
    charset="utf-8"></script>

  <script type="text/javascript">
    var browser = getBrowser();
    var json_str = '{$menus|raw}';
    var menuData = JSON.parse(json_str);
    var treeObj = treeData(menuData, 'id', 'pid', 'children');
    var that = null;

    var app = new Vue({
      el: "#app",
      data() {
        return {
          conf: {
            showAMenu: true,
            showRouteNav: true,
            showProcess: true,
          },
          menuCollapse: localStorage.getItem('menuCollapse') == 'y',
          hasTopMenu: '{$index_top_menu ?? 0}' == '1',
          leftMenuVisible: true,
          topMenu: [],
          pathList: [],
          processList: [
            {
              id: '{$dashbord.id}',
              label: '{$dashbord.name}',
              value: '{$dashbord.url}',
            }
          ],
          leftMenu: treeObj,
          iframeLoading: true,
          activeTabId: '{$dashbord.id}',
          activeTabIndex: 0,
          drawer: {
            visible: false
          },
          desc: {
            visible: false,
            color: "",
            conf: ""
          },
          theme: {
            label: "钴蓝",
            name: "blue",
            color: "#4165d7"
          },
          themes: [
            {
              label: "钴蓝",
              name: "blue",
              color: "#4165d7"
            },
            {
              label: "极黑",
              name: "black",
              color: "#2f3447"
            },
            {
              label: "果绿",
              name: "green",
              color: "#51C21A"
            },
            {
              label: "酱紫",
              name: "purple",
              color: "#d0378d"
            }
          ],
        }
      },
      computed: {
        toplist() {
          return that.topMenu.filter(e => e.isShow);
        },
      },
      mounted() {
        that = this;
        document.getElementById('app').className = '';
      },
      methods: {
        collapseMenu(is) {
          that.menuCollapse = is;
          localStorage.setItem('menuCollapse', is ? 'y' : 'n');
        },
        onCommand(e) {
          if (e == 'exit') {
            that.$confirm('确定要注销登录?', '提示', {
              confirmButtonText: '确定',
              cancelButtonText: '取消',
              type: 'warning'
            }).then(() => {
              location.replace("{:url('/admin/index/logout')}");
            }).catch(() => {
              //
            });
          }
          else {
            var arr = e.split('|');
            var find = this.processList.find(e => e.value == arr[1]);
            if (find) {
              this.activeItem(find);
            }
            else {
              this.openPage(
                {
                  id: arr[1].replace(/\W/g, ''),
                  label: arr[0],
                  value: arr[1],
                }
              );
            }
          }
        },
        tabDropdownAction(e) {
          if (e == 'current') {
            this.onDel(this.processList.findIndex(e => e.id == this.activeTabId));
            this.toPath();
          }
          else if (e == 'other') {
            this.processList = this.processList.filter(
              e => e.id == this.activeTabId || e.value == "{$dashbord.url}"
            );
            this.toPath();
          }
          else if (e == 'all') {
            this.processList = this.processList.filter(
              e => e.value == "{$dashbord.url}"
            );
            this.toPath();
          }
        },
        openTheme() {
          that.drawer.visible = true;
        },
        onSelect(e) {
          console.log(e);
        },
        initTopMenu() {

        },
        setTheme({ name, color, label }) {
          if (that.theme.color == color) {
            return false;
          }
          that.$message.success(`切换主题：${label}`);
          var theme = document.getElementById("theme-style");
          var style = theme || document.createElement("link");
          style.href = `/assets/elementui/theme/${name}.css`;
          if (!theme) {
            style.type = "text/css";
            style.rel = "stylesheet";
            style.id = "theme-style";
            document.getElementsByTagName("head").item(0).appendChild(style);
          }
          // 设置主题色和路径
          that.theme.color = color;
          that.theme.url = style.href;
          localStorage.setItem('index_theme', name);
          // 设置 css 变量
          document.getElementsByTagName("body")[0].style.setProperty("--color-primary", color);
        },
        /*tab操作*/
        activeItem(item, index) {
          if (!item || this.activeTabId == item.id) {
            return;
          }
          this.activeTabId = item.id;

          if (index === undefined) {
            for (var i in this.processList) {
              if (this.processList[i].id == item.id) {
                index = i;
                break;
              }
            }
          }
          var diff = 50 * (index - this.activeTabIndex);//判断是往左点还是往右点，加上惯性
          this.activeTabIndex = index;
          const el = this.$refs[`item-${item.id}`][0];
          if (el) {
            that.scrollToItem(el.offsetLeft + el.clientWidth - that.$refs["scroller"].clientWidth + diff);
          }
        },
        onDel(index) {
          if (index != 0) {
            this.processList.splice(index, 1);
            var find = this.processList.find(e => e.id == this.activeTabId);
            if (!find) {
              if (index > 1) {
                this.activeItem(this.processList[index - 1], index - 1);
              }
              else {
                this.toPath();
              }
            }
          }
        },
        toPath() {
          var find = this.processList.find(e => e.id == this.activeTabId);
          if (!find) {
            var next = last(this.processList);
            if (next) {
              this.activeTabId = next.id;
            }
          }
        },
        toScroll(isLeft) {
          this.scrollToItem(this.$refs["scroller"].scrollLeft + (isLeft ? -100 : 100));
        },
        scrollToItem(leftPos) {
          this.$refs["scroller"].scrollTo({
            left: leftPos,
            behavior: "smooth"
          });
        },
        leftMenuSelect(id) {
          var find = this.processList.find(e => e.id == id);
          if (find) {
            this.activeItem(find);
          }
          else {
            var find0 = menuData.find(e => e.id == id);
            if (find0) {
              this.openPage(
                {
                  id: find0.id,
                  label: find0.name,
                  value: find0.url,
                }
              );
            }
          }
        },
        openPage(item) {
          this.processList.push(item);
          Vue.nextTick(function () {
            setTimeout(function () {
              that.activeItem(item, that.processList.length - 1);
            }, 100);
          });

          this.iframeLoading = true;
          setTimeout(function () {
            this.iframeLoading = false;
          }, 3000);
        }
      }
    });
  </script>
</body>

</html>